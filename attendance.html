<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YLC 2026 Attendance | FEBIAS College of Bible</title>

<link rel="icon" href="logo.ico">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: #f8f8f8;
  color: #1f2937;
  line-height: 1.5;
  padding: 2rem;
}

h1 { text-align: center; color: #0b3d2e; margin-bottom: 2rem; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 2rem;
}

th, td {
  border: 1px solid #ccc;
  padding: 0.8rem;
  text-align: left;
}

th {
  background: #0b3d2e;
  color: #fff;
}

.status-paid { color: green; font-weight: bold; }
.status-onsite { color: orange; font-weight: bold; }
.status-not { color: red; font-weight: bold; }

.attendance-check { cursor: pointer; text-align: center; font-size: 1.2rem; }
</style>
</head>
<body>

<h1>YLC 2026 Attendance</h1>
<p>Click on the attendance indicator to mark campers. Payment status updates automatically if attended.</p>

<table id="attendance-table">
  <thead>
    <tr>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Payment Status</th>
      <th>Attendance</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows will load dynamically -->
  </tbody>
</table>

<script>
const sheetUrl = "https://script.google.com/macros/s/AKfycbzEMOPQOPhDKRpSSNZx8iNMo2J-8xxW0c9tREHLi40-5c1idUoq69g5LYVRSjl5QGi_BQ/exec";

async function loadAttendance() {
  const tbody = document.querySelector("#attendance-table tbody");
  tbody.innerHTML = "";

  try {
    const res = await fetch(`${sheetUrl}?action=getAll`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='4'>No data available.</td></tr>";
      return;
    }

    data.forEach((person, index) => {
      const tr = document.createElement("tr");

      // Ensure rowIndex exists
      person.rowIndex = person.rowIndex || (index + 2);

      // First Name
      const tdFirst = document.createElement("td");
      tdFirst.textContent = person["First Name"] || "";
      tr.appendChild(tdFirst);

      // Last Name
      const tdLast = document.createElement("td");
      tdLast.textContent = person["Last Name"] || "";
      tr.appendChild(tdLast);

      // Payment Status
      const tdPayment = document.createElement("td");
      const paymentLower = (person["Payment Status"] || "").toLowerCase();
      if (paymentLower.includes("paid") || paymentLower.includes("confirmed")) {
        tdPayment.textContent = "‚úÖ Paid";
        tdPayment.className = "status-paid";
      } else if (paymentLower.includes("onsite")) {
        tdPayment.textContent = "‚ö†Ô∏è Onsite";
        tdPayment.className = "status-onsite";
      } else {
        tdPayment.textContent = "‚ùå Not Paid";
        tdPayment.className = "status-not";
      }
      tr.appendChild(tdPayment);

      // Attendance
      const tdAttend = document.createElement("td");
      tdAttend.className = "attendance-check";
      const attendanceStatus = person["Attendance Status"];
      tdAttend.textContent = attendanceStatus === "Attended" ? "‚úÖ" :
                             attendanceStatus === "ON-waiting" ? "üü†" :
                             attendanceStatus === "Cancelled" ? "‚ùå" : "‚ö†Ô∏è";

      tdAttend.addEventListener("click", async () => {
        if (!person.rowIndex) {
          alert("Row index not found. Cannot update attendance.");
          return;
        }

        let newAttendance;
        if(tdAttend.textContent === "‚úÖ") {
          tdAttend.textContent = "üü†";
          newAttendance = "Waiting";
        } else if(tdAttend.textContent === "üü†") {
          tdAttend.textContent = "‚ùå";
          newAttendance = "Cancelled";
        } else {
          tdAttend.textContent = "‚úÖ";
          newAttendance = "Attended";
          tdPayment.textContent = "‚úÖ Paid";
          tdPayment.className = "status-paid";
        }

        try {
          const formData = new FormData();
          formData.append("action", "attendance");
          formData.append("rowIndex", person.rowIndex);
          formData.append("attendance_status", newAttendance);

          const updateRes = await fetch(sheetUrl, { method: "POST", body: formData });
          const result = await updateRes.json();

          if(result.result !== "success") {
            alert("Error updating attendance: " + result.error);
          }
        } catch(err) {
          console.error("Network error:", err);
          alert("Network error. Please try again.");
        }
      });

      tr.appendChild(tdAttend);
      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("Failed to load attendance:", err);
    tbody.innerHTML = "<tr><td colspan='4'>Unable to load data. Check Apps Script deployment, permissions, or network.</td></tr>";
  }
}

// Load on page open
loadAttendance();
</script>

</body>
</html>
