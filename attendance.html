<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YLC 2026 Attendance | FEBIAS College of Bible</title>

<link rel="icon" href="logo.ico">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;800&display=swap" rel="stylesheet">

<style>
body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: #f8f8f8;
  color: #1f2937;
  line-height: 1.5;
  padding: 2rem;
}

h1 { text-align: center; color: #0b3d2e; margin-bottom: 2rem; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 2rem;
}

th, td {
  border: 1px solid #ccc;
  padding: 0.8rem;
  text-align: left;
}

th {
  background: #0b3d2e;
  color: #fff;
}

.status-paid { color: green; font-weight: bold; }
.status-onsite { color: orange; font-weight: bold; }
.status-not { color: red; font-weight: bold; }

.attendance-check {
  cursor: pointer;
  text-align: center;
  font-size: 1.3rem;
}
</style>
</head>
<body>

<h1>YLC 2026 Attendance</h1>
<p>Click the emoji to update attendance.</p>

<button onclick="loadAttendance()">ðŸ”„ Refresh Now</button>

<table id="attendance-table">
  <thead>
    <tr>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Payment Status</th>
      <th>Attendance</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const sheetUrl = "https://script.google.com/macros/s/AKfycbzEMOPQOPhDKRpSSNZx8iNMo2J-8xxW0c9tREHLi40-5c1idUoq69g5LYVRSjl5QGi_BQ/exec?sheet=ylc";
const tbody = document.querySelector("#attendance-table tbody");

let isUpdating = false;

async function loadAttendance() {
  if (isUpdating) return;

  try {
    const res = await fetch(sheetUrl);
    const data = await res.json();

    if (!Array.isArray(data)) {
      console.error("Invalid data:", data);
      return;
    }

    tbody.innerHTML = "";

    data.forEach(person => {
      const tr = document.createElement("tr");

      const firstName = person["First Name"] || "";
      const lastName = person["Last Name"] || "";
      const paymentStatus = person["Payment Status"] || "";
      const attendanceStatus = person["Attendance Status"] || "";

      const tdFirst = document.createElement("td");
      tdFirst.textContent = firstName;

      const tdLast = document.createElement("td");
      tdLast.textContent = lastName;

      const tdPayment = document.createElement("td");

      if (paymentStatus.toLowerCase().includes("online")) {
        tdPayment.textContent = "âœ… Paid";
        tdPayment.className = "status-paid";
      } else if (paymentStatus.toLowerCase().includes("onsite")) {
        tdPayment.textContent = "âš ï¸ Onsite";
        tdPayment.className = "status-onsite";
      } else {
        tdPayment.textContent = "âŒ Not Paid";
        tdPayment.className = "status-not";
      }

      const tdAttend = document.createElement("td");
      tdAttend.className = "attendance-check";

      let currentStatus = attendanceStatus;

      function updateEmoji(status) {
        if (status === "Attended") {
          tdAttend.textContent = "âœ…";
        } else if (status === "Cancelled") {
          tdAttend.textContent = "âŒ";
        } else {
          tdAttend.textContent = "ðŸŸ ";
        }
      }

      updateEmoji(currentStatus);

      tdAttend.addEventListener("click", async () => {

        if (isUpdating) return;

        isUpdating = true;
        tdAttend.style.pointerEvents = "none";

        let newStatus;

        if (currentStatus === "Attended") {
          newStatus = "Waiting";
        } else if (currentStatus === "ON-waiting" || currentStatus === "Waiting") {
          newStatus = "Cancelled";
        } else {
          newStatus = "Attended";
        }

        const formData = new FormData();
        formData.append("action", "attendance");
        formData.append("rowIndex", person.rowIndex);
        formData.append("attendance_status", newStatus);
        formData.append("sheet", "ylc");

        try {
          const update = await fetch(sheetUrl, {
            method: "POST",
            body: formData
          });

          const result = await update.json();

          if (result.result === "success") {
            currentStatus = newStatus;
            updateEmoji(newStatus);
          } else {
            alert("Update failed: " + result.error);
          }

        } catch (err) {
          console.error("Update error:", err);
          alert("Network error.");
        }

        tdAttend.style.pointerEvents = "auto";
        isUpdating = false;
      });

      tr.appendChild(tdFirst);
      tr.appendChild(tdLast);
      tr.appendChild(tdPayment);
      tr.appendChild(tdAttend);

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("Load error:", err);
  }
}

loadAttendance();

// âœ… Safe auto refresh every 30 seconds
setInterval(() => {
  loadAttendance();
}, 30000);

</script>

</body>
</html>
