<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YLC 2026 Attendance | FEBIAS College of Bible</title>

<link rel="icon" href="logo.ico">

<style>
body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: #f8f8f8;
  color: #1f2937;
  padding: 2rem;
}

h1 { text-align: center; color: #0b3d2e; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1.5rem;
}

th, td {
  border: 1px solid #ccc;
  padding: 0.8rem;
}

th {
  background: #0b3d2e;
  color: white;
}

.status-paid { color: green; font-weight: bold; }
.status-onsite { color: orange; font-weight: bold; }
.status-not { color: red; font-weight: bold; }

.attendance-check {
  cursor: pointer;
  text-align: center;
  font-size: 1.4rem;
}
</style>
</head>
<body>

<h1>YLC 2026 Attendance</h1>
<p>Click the emoji to update attendance.</p>

<button onclick="loadAttendance()">ðŸ”„ Refresh Now</button>

<table id="attendance-table">
<thead>
<tr>
<th>First Name</th>
<th>Last Name</th>
<th>Payment Status</th>
<th>Attendance</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbwSyyqzGF7IK6L_rmdRFg7EBGOPfoyUQRrXKlCSNBx9vTz-7GwVuFTUnSw5qjOIUakpUQ/exec";
const tbody = document.querySelector("#attendance-table tbody");

let isUpdating = false;

// ===============================
// LOAD DATA
// ===============================
async function loadAttendance() {
  if (isUpdating) return;

  try {
    const res = await fetch(BASE_URL + "?sheet=ylc");
    const data = await res.json();

    if (!Array.isArray(data)) return;

    tbody.innerHTML = "";

    data.forEach(person => {

      const tr = document.createElement("tr");

      const tdFirst = document.createElement("td");
      tdFirst.textContent = person.firstName || "";

      const tdLast = document.createElement("td");
      tdLast.textContent = person.lastName || "";

      const tdPayment = document.createElement("td");
      const payment = (person.paymentStatus || "").toLowerCase();

      if (payment.includes("online")) {
        tdPayment.textContent = "âœ… Paid";
        tdPayment.className = "status-paid";
      } else if (payment.includes("onsite")) {
        tdPayment.textContent = "âš ï¸ Onsite";
        tdPayment.className = "status-onsite";
      } else {
        tdPayment.textContent = "âŒ Not Paid";
        tdPayment.className = "status-not";
      }

      const tdAttend = document.createElement("td");
      tdAttend.className = "attendance-check";

      let currentStatus = person.attendanceStatus || "ON-waiting";

      function updateEmoji(status) {
        if (status === "Attended") {
          tdAttend.textContent = "âœ…";
        } else if (status === "Cancelled") {
          tdAttend.textContent = "âŒ";
        } else {
          tdAttend.textContent = "ðŸŸ ";
        }
      }

      updateEmoji(currentStatus);

      // ===============================
      // CLICK HANDLER
      // ===============================
      tdAttend.addEventListener("click", async () => {

        if (isUpdating) return;

        isUpdating = true;
        tdAttend.style.pointerEvents = "none";

        let newStatus;

        if (currentStatus === "Attended") {
          newStatus = "Waiting";
        } else if (currentStatus === "Cancelled") {
          newStatus = "Waiting";
        } else {
          newStatus = "Attended";
        }

        const formData = new FormData();
        formData.append("action", "attendance");
        formData.append("rowIndex", person.rowIndex);
        formData.append("attendance_status", newStatus);
        formData.append("sheet", "ylc");

        try {
          const response = await fetch(BASE_URL, {
            method: "POST",
            body: formData
          });

          const result = await response.json();

          if (result.result === "success") {
            currentStatus = newStatus;
            updateEmoji(newStatus);
          } else {
            alert("Update failed.");
          }

        } catch (err) {
          alert("Network error.");
          console.error(err);
        }

        tdAttend.style.pointerEvents = "auto";
        isUpdating = false;
      });

      tr.appendChild(tdFirst);
      tr.appendChild(tdLast);
      tr.appendChild(tdPayment);
      tr.appendChild(tdAttend);

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error("Load error:", err);
  }
}

// Initial load
loadAttendance();

// Auto refresh every 30 seconds
setInterval(loadAttendance, 30000);

</script>

</body>
</html>
