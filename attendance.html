<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YLC 2026 Attendance | FEBIAS College of Bible</title>

<link rel="icon" href="logo.ico">

<style>
body {
  font-family: "Segoe UI", system-ui, sans-serif;
  background: #f8f8f8;
  color: #1f2937;
  padding: 2rem;
}

h1 { text-align: center; color: #0b3d2e; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1.5rem;
}

th, td {
  border: 1px solid #ccc;
  padding: 0.8rem;
}

th {
  background: #0b3d2e;
  color: white;
}

.status-paid { color: green; font-weight: bold; }
.status-onsite { color: orange; font-weight: bold; }
.status-not { color: red; font-weight: bold; }

.attendance-check {
  cursor: pointer;
  text-align: center;
  font-size: 1.4rem;
}
</style>
</head>
<body>

<h1>YLC 2026 Attendance</h1>
<p>Click the emoji to update attendance.</p>

<button onclick="loadAttendance()">ðŸ”„ Refresh Now</button>

<table id="attendance-table">
<thead>
<tr>
<th>First Name</th>
<th>Last Name</th>
<th>Payment Status</th>
<th>Attendance</th>
</tr>
</thead>
<tbody></tbody>
</table>
<script>
const BASE_URL = "https://script.google.com/macros/s/AKfycbwSyyqzGF7IK6L_rmdRFg7EBGOPfoyUQRrXKlCSNBx9vTz-7GwVuFTUnSw5qjOIUakpUQ/exec";
const tbody = document.querySelector("#attendance-table tbody");

let peopleMap = new Map(); // store rows by rowIndex
let isSyncing = false;

// ===============================
// RENDER OR UPDATE ROW
// ===============================
function renderRow(person) {

  let existingRow = peopleMap.get(person.rowIndex);

  if (!existingRow) {
    const tr = document.createElement("tr");
    tr.dataset.row = person.rowIndex;

    tr.innerHTML = `
      <td>${person.firstName || ""}</td>
      <td>${person.lastName || ""}</td>
      <td class="payment"></td>
      <td class="attendance-check"></td>
    `;

    tbody.appendChild(tr);
    peopleMap.set(person.rowIndex, tr);
    existingRow = tr;
  }

  const paymentCell = existingRow.querySelector(".payment");
  const attendanceCell = existingRow.querySelector(".attendance-check");

  // Payment display
  const payment = (person.paymentStatus || "").toLowerCase();

  if (payment.includes("online")) {
    paymentCell.textContent = "âœ… Paid";
    paymentCell.className = "payment status-paid";
  } else if (payment.includes("onsite")) {
    paymentCell.textContent = "âš ï¸ Onsite";
    paymentCell.className = "payment status-onsite";
  } else {
    paymentCell.textContent = "âŒ Not Paid";
    paymentCell.className = "payment status-not";
  }

  // Attendance emoji
  function setEmoji(status) {
    if (status === "Attended") attendanceCell.textContent = "âœ…";
    else if (status === "Cancelled") attendanceCell.textContent = "âŒ";
    else attendanceCell.textContent = "ðŸŸ ";
  }

  setEmoji(person.attendanceStatus);

  // Prevent duplicate listeners
  attendanceCell.onclick = async () => {

    if (isSyncing) return;
    isSyncing = true;

    let newStatus;

    if (person.attendanceStatus === "Attended") {
      newStatus = "Waiting";
    } else {
      newStatus = "Attended";
    }

    // ðŸ”¥ INSTANT UI UPDATE (NO WAIT)
    person.attendanceStatus = newStatus;
    setEmoji(newStatus);

    const formData = new FormData();
    formData.append("action", "attendance");
    formData.append("rowIndex", person.rowIndex);
    formData.append("attendance_status", newStatus);
    formData.append("sheet", "ylc");

    try {
      await fetch(BASE_URL, {
        method: "POST",
        body: formData
      });
    } catch (err) {
      console.error("Sync failed:", err);
    }

    isSyncing = false;
  };
}


// ===============================
// LOAD DATA (SMART UPDATE)
// ===============================
async function loadAttendance() {

  if (isSyncing) return;

  try {
    const res = await fetch(BASE_URL + "?sheet=ylc");
    const data = await res.json();

    if (!Array.isArray(data)) return;

    data.forEach(person => {
      renderRow(person);
    });

  } catch (err) {
    console.error("Load error:", err);
  }
}


// ===============================
// INITIAL LOAD
// ===============================
loadAttendance();

// ðŸ”„ Silent auto-refresh every 20 sec (NO table wipe)
setInterval(loadAttendance, 20000);
</script>


</body>
</html>
