<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YLC 2026 Payment | FEBIAS College of Bible</title>
<link rel="icon" href="logo.ico">
<style>
input[type=text], input[type=file]{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #c9a227;}
.payment-box.selected { border: 2px solid #c9a227; }
.notice { margin:10px 0; color:#c9a227; font-weight:bold; }
.payment-box { cursor:pointer; display:inline-block; padding:10px; border:1px solid #ccc; border-radius:8px; margin:5px; text-align:center; }
.payment-box img { width:50px; display:block; margin:0 auto 5px; }
</style>
</head>
<body>
<div class="container">
<h1>YLC 2026 Payment Confirmation</h1>

<form id="payment-form">
<h2>Enter your registration email</h2>
<input type="email" id="regEmail" placeholder="Your email" required>

<h2>Select Payment Type</h2>
<label><input type="radio" name="payment_by" value="Onsite" required> Onsite Payment</label>
<label><input type="radio" name="payment_by" value="Online"> Online Payment</label>

<div class="notice">⚠️ Please screenshot your registration confirmation and present it onsite if online.</div>

<h2>Payment Methods</h2>
<div class="payment-methods">
  <div class="payment-box" data-method="Bank Numbers">
    <img src="bank.png" alt="Bank Numbers"><span>Bank Numbers</span>
  </div>
  <div class="payment-box" data-method="GCash QR">
    <img src="gcash.png" alt="GCash QR"><span>GCash QR</span>
  </div>
</div>

<div id="online-upload" style="display:none;">
  <label for="fileName">Enter your receipt name:</label>
  <input type="text" id="fileName">
  <label for="receipt">Upload receipt photo:</label>
  <input type="file" id="receipt" accept="image/*">
  <div class="notice">⚠️ Make sure the filename matches your registration name.</div>
</div>

<button type="submit">✅ Confirm Payment</button>
</form>
</div>

<footer>© 2026 FEBIAS College of Bible — Youth Leaders Camp</footer>

<script>
const sheetUrl = "https://script.google.com/macros/s/AKfycbwwHV3lRXqX4ZEuRVojk39a28nu_Mx8l1cg3Zb4FQVkfA34RInL_oqUBOp3fVmRiOm7Rg/exec"; // sheet web app
const driveUrl = "https://script.google.com/macros/s/AKfycbzUuUYbHJdFAPtKc--MWy9B93cl4X--TtMc3IsaA3IR3Q0JBaEominP9t9nFxRVIYcR/exec"; // drive web app

// Show/hide online upload
document.querySelectorAll('input[name="payment_by"]').forEach(radio=>{
  radio.addEventListener('change', ()=> {
    document.getElementById('online-upload').style.display = radio.value==='Online' ? 'block' : 'none';
  });
});

// Highlight payment box
document.querySelectorAll('.payment-box').forEach(box=>{
  box.addEventListener('click', ()=> {
    document.querySelectorAll('.payment-box').forEach(b=>b.classList.remove('selected'));
    box.classList.add('selected');
  });
});

document.getElementById('payment-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('regEmail').value.trim();
  const paymentBy = document.querySelector('input[name="payment_by"]:checked')?.value;
  const selectedBox = document.querySelector('.payment-box.selected');
  const method = selectedBox?.dataset.method;

  if(!email){ alert('Please enter your email'); return; }
  if(!paymentBy){ alert('Please select payment type'); return; }
  if(!method){ alert('Please select payment method'); return; }

  // 1️⃣ Check email
  let rowIndex;
  try{
    const params = new URLSearchParams({action:'checkEmail', email, sheet:'ylc'});
    const res = await fetch(sheetUrl + "?" + params.toString(), {method:'GET'});
    const data = await res.json();
    if(data.result!=='success'){ alert("Email not found. Please register first."); return; }
    rowIndex = data.rowIndex;
  } catch(err){ alert('Failed to check registration: '+err); return; }

  // 2️⃣ Update payment
  try{
    const postData = new URLSearchParams();
    postData.append('action','payment');
    postData.append('rowIndex', rowIndex);
    postData.append('sheet','ylc');
    postData.append('payment_by', paymentBy+' ('+method+')');
    const res = await fetch(sheetUrl,{method:'POST', body:postData});
    const result = await res.json();
    if(result.result!=='success'){ alert('Sheet update failed: '+result.error); return; }
  } catch(err){ alert('Failed to update payment: '+err); return; }

  // 3️⃣ Upload file if online
  if(paymentBy==='Online'){
    const file = document.getElementById('receipt').files[0];
    const fileName = document.getElementById('fileName').value.trim();
    if(!file || !fileName){ alert('Please enter file name and select file'); return; }

    const reader = new FileReader();
    reader.onload = async ()=>{
      const base64 = reader.result.split(',')[1];
      const postData = new URLSearchParams();
      postData.append('fileName', fileName);
      postData.append('file', base64);
      postData.append('fileType', file.type);

      try{
        const res = await fetch(driveUrl,{method:'POST', body:postData});
        const result = await res.json();
        if(result.result!=='success'){ alert('Drive upload failed: '+result.error); return; }
        alert('Payment and receipt uploaded successfully!');
        window.location.href='thankyou.html';
      } catch(err){ alert('Drive upload failed: '+err); return; }
    };
    reader.readAsDataURL(file);
  } else {
    alert('Payment updated successfully!');
    window.location.href='thankyou.html';
  }
});
</script>
</body>
</html>
