<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YLC 2026 Payment | FEBIAS College of Bible</title>
<link rel="icon" href="logo.ico">
<style>
/* ... your previous CSS intact ... */
input[type=text], input[type=file]{width:100%;margin-top:6px;padding:10px;border-radius:8px;border:1px solid #c9a227;}
</style>
</head>
<body>

<div class="container">
<h1>YLC 2026 Payment Confirmation</h1>

<form id="payment-form">
<h2>Enter your registration email</h2>
<input type="email" id="regEmail" placeholder="Your email" required>

<h2>Select Payment Type</h2>
<label><input type="radio" name="payment_by" value="Onsite" required> Onsite Payment</label>
<label><input type="radio" name="payment_by" value="Online"> Online Payment</label>

<div class="notice">
⚠️ Please screenshot your registration confirmation and present it onsite if online.
</div>

<h2>Payment Methods</h2>
<div class="payment-methods">
  <div class="payment-box" data-method="Bank Numbers">
    <img src="bank.png" alt="Bank Numbers"><span>Bank Numbers</span>
  </div>
  <div class="payment-box" data-method="GCash QR">
    <img src="gcash.png" alt="GCash QR"><span>GCash QR</span>
  </div>
</div>

<!-- Online Payment Upload -->
<div id="online-upload" style="display:none;">
  <label for="fileName">Enter your receipt name:</label>
  <input type="text" id="fileName">
  <label for="receipt">Upload receipt photo:</label>
  <input type="file" id="receipt" accept="image/*">
  <div class="notice">⚠️ Make sure the filename matches your registration name.</div>
</div>

<button type="submit">✅ Confirm Payment</button>
</form>
</div>

<footer>© 2026 FEBIAS College of Bible — Youth Leaders Camp</footer>

<script>
// Show/hide upload fields for online payment
const paymentRadios = document.querySelectorAll('input[name="payment_by"]');
const onlineUpload = document.getElementById("online-upload");
paymentRadios.forEach(r => {
  r.addEventListener("change", () => {
    onlineUpload.style.display = r.value==="Online" ? "block" : "none";
  });
});

// Highlight selected payment box
const boxes = document.querySelectorAll(".payment-box");
boxes.forEach(box => {
  box.addEventListener("click", () => {
    boxes.forEach(b => b.classList.remove("selected"));
    box.classList.add("selected");
  });
});

document.getElementById("payment-form").addEventListener("submit", async function(e){
  e.preventDefault();

  const email = document.getElementById("regEmail").value.trim();
  if(!email){ alert("Please enter your registration email."); return; }

  const paymentBy = document.querySelector('input[name="payment_by"]:checked')?.value;
  if(!paymentBy){ alert("Please select a payment type."); return; }

  const selectedBox = document.querySelector(".payment-box.selected");
  let method = selectedBox ? selectedBox.dataset.method : "";
  if(!method){ alert("Please select a payment method."); return; }

  // 1️⃣ Check email in sheet
  const sheetCheckUrl = "https://script.google.com/macros/s/AKfycbyrzex93Ouc6Zjqa8ELzF1xb1WKA1P4AoITlOJ5kygYOO-b1GDJNL71zHhPEiC8XaRRfg/exec";
  try {
    const checkRes = await fetch(sheetCheckUrl, {
      method:"POST",
      body: new URLSearchParams({action:"checkEmail", email: email, sheet:"ylc"})
    });
    const checkResult = await checkRes.json();
    if(checkResult.result !== "success"){ alert("Email not found. Please register first."); return; }
    var rowIndex = checkResult.rowIndex;
  } catch(err){ alert("Failed to check registration. "+err); return; }

  // 2️⃣ Update payment in sheet
  const sheetForm = new FormData();
  sheetForm.append("action","payment");
  sheetForm.append("rowIndex", rowIndex);
  sheetForm.append("sheet","ylc");
  sheetForm.append("payment_by", paymentBy + " (" + method + ")");

  try{
    const sheetRes = await fetch(sheetCheckUrl, { method:"POST", body:sheetForm });
    const sheetResult = await sheetRes.json();
    if(sheetResult.result !== "success"){ alert("Sheet update failed: "+sheetResult.error); return; }
  } catch(err){ alert("Sheet update failed. "+err); return; }

  // 3️⃣ Online payment upload
  if(paymentBy==="Online"){
    const fileInput = document.getElementById("receipt");
    const fileNameInput = document.getElementById("fileName");
    const file = fileInput.files[0];
    const fileName = fileNameInput.value.trim();
    if(!file || !fileName){ alert("Please enter filename and select a file."); return; }

    const reader = new FileReader();
    reader.onload = async function() {
      const base64 = reader.result.split(",")[1];
      const driveForm = new FormData();
      driveForm.append("fileName", fileName);
      driveForm.append("file", base64);
      driveForm.append("fileType", file.type);

      const driveUrl = "https://script.google.com/macros/s/AKfycbzUuUYbHJdFAPtKc--MWy9B93cl4X--TtMc3IsaA3IR3Q0JBaEominP9t9nFxRVIYcR/exec";

      try{
        const driveRes = await fetch(driveUrl, { method:"POST", body:driveForm });
        const driveResult = await driveRes.json();
        if(driveResult.result !== "success"){ alert("Drive upload failed: "+driveResult.error); return; }
        alert("Payment and receipt uploaded successfully!");
        window.location.href="thankyou.html";
      } catch(err){ alert("Drive upload failed: "+err); return; }
    };
    reader.readAsDataURL(file);
  } else {
    alert("Payment updated successfully!");
    window.location.href="thankyou.html";
  }
});
</script>
</body>
</html>
